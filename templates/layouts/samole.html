{% comment %} {% extends 'layouts/main.html' %}
{% load static %}

{% block body %}
<div class="inner_page-banner one-img" style="text-align: center; background: url('{% static 'lap/images/smallbanner.jpeg' %}') no-repeat center; background-size: cover; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; -ms-background-size: cover; min-height: 350px;"></div>
<br><br>
<section class="section-content padding-y bg">
    <div class="container">
        <div class="row">
           <aside class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Billing Address</h4>
                        {% if default_address %}
                            <p>
                                <strong>Name:</strong> {{ default_address.first_name }} {{ default_address.last_name }}<br>
                                <strong>Email:</strong> {{ default_address.email }}<br>
                                <strong>Phone Number:</strong> {{ default_address.phone_number }}<br>
                                <strong>Address:</strong> {{ default_address.street }}, {{ default_address.city }}, {{ default_address.state }}, {{ default_address.country }} - {{ default_address.pincode }}<br>
                                <strong>Landmark:</strong> {{ default_address.land_mark }}
                            </p>
                            <a href="{% url 'show_addresses' %}" class="btn btn-primary">Change Address</a>
                        {% else %}
                            <p>No default address found.</p>
                            <a href="{% url 'add_address' %}" class="btn btn-primary">Add Address</a>
                        {% endif %}
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-body">
                        <h4 class="card-title">Select Payment</h4>
                        <div class="form-group">
                            <label for="payment_method">Payment Method:</label>
                            <select class="form-control" id="payment_method" name="payment_method">
                                <option value="credit_card">COD</option>
                                <option value="paypal">PayPal</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <!-- Add more payment options as needed -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-body">
                        <h4 class="card-title">Select Coupon</h4>
                        <form>
                            <div class="form-group">
                                <label for="coupon_code">Coupon Code:</label>
                                <input type="text" class="form-control" id="coupon_code" name="coupon_code" placeholder="Enter coupon code">
                            </div>
                            <button type="submit" class="btn btn-primary">Apply Coupon</button>
                        </form>
                    </div>
                </div>

            </aside>
                        
    <aside class="col-lg-6">

        <div class="card">
        <div class="card-body">
          <table class="table table-borderless table-shopping-cart">
            <thead class="text-muted">
            <tr class="small text-uppercase">
                <th scope="col">Product</th>
                <th scope="col" width="120">Quantity</th>
                <th scope="col" width="120">Price</th>
               
            </tr>
            </thead>
            <tbody>

                {% for cart_item in cart_items %} {% comment %} real is cart_item in cart_items but its isnt display the cart_item details {% endcomment %}
            <tr>
                <td>
                    <figure class="itemside align-items-center">
                        <div class="aside"><img src="{{ cart_item.product.product_thumbnail.url }}" class="img-sm" style="max-width:50px"></div>
                        <figcaption class="info">
                            <a href="{% url 'single_product' cart_item.product.id %}" class="title text-dark" style="font-size:12px">{{ cart_item.product.product_name }} </a>
                            <p class="text-muted small"></p>
                        </figcaption>
                    </figure>
                </td>
                <td>
                   <label for="">{{cart_item.quantity}}</label>
                </td>
                <td>
                    <div class="price-wrap">
                        <var class="price">$ {{cart_item.sub_total}}</var>
                        <small class="text-muted"> Rs.{{cart_item.product.product_price}} each </small>
                    </div> <!-- price-wrap .// -->
              
            </tr>
            {% endfor %}
            </tbody>
            </table>
            <h6 class="btn btn-primary btn-block">Grand Total with Tax
                <span> Rs{{grand_total}}</span>
            </h6>
                    
            <a href="{% url 'checkout'%}" class="btn btn-primary btn-block"> Place Order </a>
           
        </div> <!-- card-body.// -->
        </div> <!-- card.// -->

</aside>
        </div> <!-- row.// -->
    </div> <!-- container // -->
</section>
{% endblock %}


 {% endcomment %}



def generate_order_number():
    # Generate a random order number consisting of uppercase letters and digits
    order_number = ''.join(random.choices(string.ascii_uppercase + string.digits, k=8))
    return order_number

@login_required(login_url='user_login')
def checkout(request):
    default_address = UserAddress.objects.filter(user=request.user, is_default=True).first()
    addresses = UserAddress.objects.filter(user=request.user)
    try:
        total = 0
        quantity = 0
        tax = 0
        grand_total = 0
        cart_items = None
        
        if request.user.is_authenticated:
            cart_items = CartItem.objects.filter(user=request.user, is_active=True)
        else:
            cart = Cart.objects.get(cart_id=_cart_id(request))
            cart_items = CartItem.objects.filter(cart=cart, is_active=True)
        
        for cart_item in cart_items:
            total += cart_item.product.product_price * cart_item.quantity
            quantity += cart_item.quantity
        
        tax = (2 * total) / 100
        grand_total = total + tax
    
    except ObjectDoesNotExist:
        pass
    
    context = {
        'total': total,
        'quantity': quantity,
        'cart_items': cart_items,
        'tax': tax,
        'grand_total': grand_total,
        'default_address': default_address,
        'addresses': addresses,
    }
    
    return render(request, 'layouts/checkout.html', context)
checkout



{% extends 'layouts/main.html' %}
{% load static %}

{% block body %}
<div class="inner_page-banner one-img" style="text-align: center; background: url('{% static 'lap/images/smallbanner.jpeg' %}') no-repeat center; background-size: cover; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; -ms-background-size: cover; min-height: 350px;"></div>
<br><br>
<section class="section-content padding-y bg">
    <div class="container">
        <div class="row">
            <aside class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Billing Address</h4>
                        {% if default_address %}
                            <p>
                                <strong>Name:</strong> {{ default_address.first_name }} {{ default_address.last_name }}<br>
                                <strong>Email:</strong> {{ default_address.email }}<br>
                                <strong>Phone Number:</strong> {{ default_address.phone_number }}<br>
                                <strong>Address:</strong> {{ default_address.street }}, {{ default_address.city }}, {{ default_address.state }}, {{ default_address.country }} - {{ default_address.pincode }}<br>
                                <strong>Landmark:</strong> {{ default_address.land_mark }}
                            </p>
                            <a href="{% url 'show_addresses' %}" class="btn btn-primary">Change Address</a>
                        {% else %}
                            <p>No default address found.</p>
                            <a href="{% url 'add_address' %}" class="btn btn-primary">Add Address</a>
                        {% endif %}
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-body">
                        <h4 class="card-title">Select Payment</h4>
                        <form method="post">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="payment_method">Payment Method:</label>
                                <select class="form-control" id="payment_method" name="payment_method">
                                    <option value="cash_on_delivery">Cash on Delivery</option>
                                    <option value="paypal">PayPal</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <!-- Add more payment options as needed -->
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Place Order</button>
                        </form>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-body">
                        <h4 class="card-title">Select Coupon</h4>
                        <form>
                            <div class="form-group">
                                <label for="coupon_code">Coupon Code:</label>
                                <input type="text" class="form-control" id="coupon_code" name="coupon_code" placeholder="Enter coupon code">
                            </div>
                            <button type="submit" class="btn btn-primary">Apply Coupon</button>
                        </form>
                    </div>
                </div>

            </aside>

            <aside class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <table class="table table-borderless table-shopping-cart">
                            <thead class="text-muted">
                            <tr class="small text-uppercase">
                                <th scope="col">Product</th>
                                <th scope="col" width="120">Quantity</th>
                                <th scope="col" width="120">Price</th>
                            </tr>
                            </thead>
                            <tbody>
                                {% for cart_item in cart_items %}
                                    <tr>
                                        <td>
                                            <figure class="itemside align-items-center">
                                                <div class="aside">
                                                    <img src="{{ cart_item.product.product_thumbnail.url }}" class="img-sm" style="max-width:50px">
                                                </div>
                                                <figcaption class="info">
                                                    <a href="{% url 'single_product' cart_item.product.id %}" class="title text-dark" style="font-size:12px">{{ cart_item.product.product_name }}</a>
                                                    <p class="text-muted small"></p>
                                                </figcaption>
                                            </figure>
                                        </td>
                                        <td>
                                            <label for="">{{ cart_item.quantity }}</label>
                                        </td>
                                        <td>
                                            <div class="price-wrap">
                                                <var class="price">$ {{ cart_item.sub_total }}</var>
                                                <small class="text-muted"> Rs.{{ cart_item.product.product_price }} each </small>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <h6 class="btn btn-primary btn-block">Grand Total with Tax
                            <span> Rs{{ grand_total }}</span>
                        </h6>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</section>
{% endblock %}

 # if request.method == 'POST':
    #     if default_address is None:
    #         return redirect('add_address')
    #     # Get the selected payment method from the form data
    #     payment_method = request.POST.get('payment_method', 'cash_on_delivery')
    #     # Create the Order instance
    #     order = Order.objects.create(
    #         user=request.user,
    #         payment_method=payment_method,
    #         total_mrp=grand_total,
    #         shipping_address=default_address
    #     )
    #     # Create OrderItem instances for each cart item
    #     for cart_item in cart_items:
    #         OrderItem.objects.create(
    #             order_no=order,
    #             product=cart_item.product,
    #             quantity=cart_item.quantity,
                
    #         )
    #         # Decrease the product quantity
    #         product = cart_item.product
    #         product.product_quantity -= cart_item.quantity
    #         product.save()
    #     # Clear the cart after placing the order
    #     if request.user.is_authenticated:
    #         CartItem.objects.filter(user=request.user, is_active=True).delete()
    #     else:
    #         cart = Cart.objects.get(cart_id=_cart_id(request))
    #         CartItem.objects.filter(cart=cart, is_active=True).delete()
        
    #     # Redirect to the Order Summary page with the newly created Order's ID
    #     messages.success(request, 'Your order has been placed successfully.')
    #     return redirect('order_summary', order_id=order.id)
    #     # return redirect('order_summary')